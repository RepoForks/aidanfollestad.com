#!/usr/local/bin/node
var app = require('../app');
var httpProxy = require('http-proxy'),
    http = require('http'),
    proxy = httpProxy.createProxyServer({}),
    url = require('url');

var mainPort = 8080;
var server = app.listen(mainPort, function () {
    console.log('Main server listening on port ' + mainPort);
});

var proxyPort = 80;
http.createServer(function (req, res) {
    if (!req.secure) {
        //FYI this should work for local development as well
        return res.redirect('https://' + req.headers.host + req.url);
    }

    var hostname = req.headers.host.split(":")[0];
    // var pathname = url.parse(req.url).pathname;

    switch (hostname) {
        case 'polar.aidanfollestad.com':
            proxy.web(req, res, {target: 'https://aidanfollestad.com:3000'});
            break;
        case 'www.aidanfollestad.com':
            proxy.web(req, res, {target: 'https://aidanfollestad.com:3000'});
            break;
        default:
            proxy.web(req, res, {target: 'http://aidanfollestad.com:8080'});
            break;
    }
}).listen(proxyPort, function () {
    console.log('Proxy server listening on port ' + proxyPort);
});