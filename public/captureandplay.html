<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Capture and Playback Tests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1E88E5">

    <!-- WaveSurfer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.0.52/wavesurfer.min.js"></script>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

    <!-- Materialize -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/js/materialize.min.js"></script>

    <!-- Internal -->
    <link href="/css/captureandplay.css" rel="stylesheet">
    <script src="/js/FileSaver.min.js"></script>
    <script src="/js/MediaStreamRecorder.min.js"></script>

</head>
<body>

<nav>
    <div class="nav-wrapper blue">
        <a href="#" class="brand-logo">Capture and Playback Tests</a>
    </div>
</nav>

<div id="body-content">

    <h5>Video Capture</h5>
    <button id="startVideoCameraBtn" style="margin-top: 24px; width: 300px"
            class="btn waves-effect waves-light light-blue"
            onclick="startListeningVideo()">Start Video Camera
    </button>
    <br/>
    <button id="beginCaptureBtn" style="margin-top: 12px; width: 300px" class="btn waves-effect waves-light light-blue"
            onclick="toggleVideoCapture()" disabled>Begin Capture
    </button>
    <br/>
    <video id="videoView" style="display: none" autoplay></video>

    <hr/>

    <h5>Audio Capture</h5>
    <!--<audio id="myAudio" class="video-js vjs-default-skin"></audio>-->

    <hr/>

    <h5>Audio Playback</h5>
    <div id="waveform"></div>
    <button style="margin-top: 24px" class="btn waves-effect waves-light light-blue" onclick="wavesurfer.playPause()">
        Play/Pause
    </button>

    <hr/>

    <h5>Video Playback</h5>
    <video id="videoPlayback" width="320" height="240" controls>
        <source src="https://s3.amazonaws.com/prod-extempore-expertfiles/001f0346-a03f-4a18-bb3a-d1f97eec12a4.mp4"
                type="video/mp4">
        Your browser does not support the video tag.
    </video>

</div>

<!-- VIDEO CAPTURE -->
<script>

    var videoMediaRecorder;
    var videoMediaConstraints = {
        audio: true,
        video: true  // if firefox or chrome
    };
    var isVideoRecording = false;

    function playVideo(selector, url) {
        var video = $(selector)[0];
        video.src = url;
    }

    function onVideoSuccess(stream) {
        videoMediaRecorder = new MediaStreamRecorder(stream);
        videoMediaRecorder.mimeType = 'video/mp4';
        videoMediaRecorder.ondataavailable = function (blob) {
            // POST/PUT "Blob" using FormData/XHR2
            var blobUrl = URL.createObjectURL(blob);
            playVideo('#videoView', blobUrl);
        };

        var localUrl = window.URL.createObjectURL(stream);
        playVideo('#videoView', localUrl);
        $('#videoView').show();
    }

    function onVideoError(e) {
        console.error('Video error: ', e);
    }

    function startListeningVideo() {
        navigator.getUserMedia(videoMediaConstraints, onVideoSuccess, onVideoError);
    }

    function toggleVideoCapture() {
        if (isVideoRecording) {
            videoMediaRecorder.stop();
        } else {
            videoMediaRecorder.start();
        }
        isVideoRecording = !isVideoRecording;
    }

</script>

<!-- OTHER -->
<script>

    var wavesurfer;

    //    function saveFile(obj, name) {
    //        if (obj instanceof Blob) {
    //            saveAs(obj, name);
    //        } else if (obj.video) {
    //            if (obj.video instanceof Blob) {
    //                saveAs(obj.video, name);
    //            } else {
    //                alert('Video isn\'t a blob?');
    //            }
    //        } else if (obj.audio) {
    //            if (obj.audio instanceof Blob) {
    //                saveAs(obj.audio, name);
    //            } else {
    //                alert('Audio isn\'t a blob?');
    //            }
    //        } else {
    //            alert('Didn\'t get a blob, or audio/video objects.');
    //        }
    //    }

    function playAudio(selector, url) {
        if (wavesurfer) {
            wavesurfer.stop();
            wavesurfer.destroy();
        }
        wavesurfer = WaveSurfer.create({
            container: selector,
            waveColor: 'black',
            progressColor: 'blue'
        });
        // 'https://s3.amazonaws.com/prod-extempore-expertfiles/01bef097-91c2-4195-a288-f6877e27ce0c.wav'
        wavesurfer.load(url);
    }

    $(document).ready(function () {
//        var contentWidth = $('#body-content').width();
//        var defaultVideoWidth = 320;
//        var defaultVideoHeight = 240;
//        if (defaultVideoWidth > contentWidth) {
//            defaultVideoWidth = contentWidth;
//            defaultVideoHeight = contentWidth / (defaultVideoWidth / defaultVideoHeight);
//        }
    });

</script>

</body>
</html>