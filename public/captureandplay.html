<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Capture and Playback Tests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1E88E5">

    <!-- WaveSurfer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.0.52/wavesurfer.min.js"></script>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

    <!-- Materialize -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/js/materialize.min.js"></script>

    <!-- Internal -->
    <link href="/css/captureandplay.css" rel="stylesheet">
    <script src="/js/FileSaver.min.js"></script>
    <script src="/js/MediaStreamRecorder.min.js"></script>

</head>
<body>

<nav>
    <div class="nav-wrapper blue">
        <a href="#" class="brand-logo">Capture and Playback Tests</a>
    </div>
</nav>

<div id="body-content">

    <h5>Video Capture</h5>
    <button id="startVideoCameraBtn" style="margin-top: 24px"
            class="btn waves-effect waves-light light-blue"
            onclick="startListeningVideo()">Start Video Camera
    </button>
    <br/>
    <button id="beginCaptureBtn" style="margin-top: 12px" class="btn waves-effect waves-light light-blue"
            onclick="toggleVideoCapture()" disabled>Begin Capture
    </button>
    <br/>
    <video id="videoView" style="display: none; margin-top: 24px" autoplay></video>

    <hr/>

    <h5>Audio Capture</h5>
    <button id="startMicrophoneBtn" style="margin-top: 24px"
            class="btn waves-effect waves-light light-blue"
            onclick="startListeningAudio()">Start Microphone
    </button>
    <br/>
    <button id="beginAudioCaptureBtn" style="margin-top: 12px" class="btn waves-effect waves-light light-blue"
            onclick="toggleAudioCapture()" disabled>Begin Capture
    </button>
    <br/>
    <div id="audioView" style="display: none; margin-top: 24px"></div>
    <br/>
    <button id="audioPlaybackBtn" style="margin-top: 12px; display: none" class="btn waves-effect waves-light light-blue"
            onclick="toggleAudioPlayback()">Play Audio
    </button>
    <hr/>

    <h5>Audio Playback</h5>
    <div id="waveform"></div>
    <button style="margin-top: 24px" class="btn waves-effect waves-light light-blue">
        Play/Pause
    </button>

    <hr/>

    <h5>Video Playback</h5>
    <video id="videoPlayback" width="320" height="240" controls>
        <source src="https://s3.amazonaws.com/prod-extempore-expertfiles/001f0346-a03f-4a18-bb3a-d1f97eec12a4.mp4"
                type="video/mp4">
        Your browser does not support the video tag.
    </video>

</div>

<!-- VIDEO CAPTURE -->
<script>

    var videoMediaRecorder;
    var videoMediaConstraints = {
        audio: true,
        video: true  // if firefox or chrome
    };
    var isVideoRecording = false;

    function playVideo(selector, url, showControls) {
        var video = $(selector)[0];
        video.src = url;
        if (!showControls && video.hasAttribute("controls")) {
            video.removeAttribute("controls")
        } else if (showControls) {
            video.setAttribute("controls", "controls")
        }
    }

    function onVideoSuccess(stream) {
        videoMediaRecorder = new MediaStreamRecorder(stream);
        videoMediaRecorder.mimeType = 'video/mp4';
        videoMediaRecorder.ondataavailable = function (blob) {
            // POST/PUT "Blob" using FormData/XHR2
            var blobUrl = URL.createObjectURL(blob);
            playVideo('#videoView', blobUrl, true);
        };

        var localUrl = window.URL.createObjectURL(stream);
        playVideo('#videoView', localUrl, false);
        $('#videoView').show();
    }

    function onVideoError(e) {
        console.error('Video error: ', e);
    }

    function startListeningVideo() {
        $('#startVideoCameraBtn').prop('disabled', true);
        $('#beginCaptureBtn').prop('disabled', false);
        navigator.getUserMedia(videoMediaConstraints, onVideoSuccess, onVideoError);
    }

    function toggleVideoCapture() {
        var btn = $('#beginCaptureBtn');
        if (isVideoRecording) {
            btn.text('Begin Capture');
            videoMediaRecorder.stop();
        } else {
            btn.text('End Capture');
            videoMediaRecorder.start();
        }
        isVideoRecording = !isVideoRecording;
    }

</script>

<!-- AUDIO CAPTURE -->
<script>

    var audioMediaRecorder;
    var audioMediaConstraints = {
        audio: true
    };
    var isAudioRecording = false;
    var isAudioPlaying = false;
    var audioPlayer;

    function playAudio(selector, url, showControls) {
        if (audioPlayer) {
            audioPlayer.stop();
            audioPlayer.destroy();
        }
        audioPlayer = WaveSurfer.create({
            container: selector,
            waveColor: 'black',
            progressColor: 'blue'
        });
        // 'https://s3.amazonaws.com/prod-extempore-expertfiles/01bef097-91c2-4195-a288-f6877e27ce0c.wav'
        audioPlayer.load(url);
        if (showControls) {
            var btn = $('#audioPlaybackBtn');
            btn.text('Play Audio');
            btn.show();
        } else {
            $('#audioPlaybackBtn').hide();
        }
    }

    function onAudioSuccess(stream) {
        audioMediaRecorder = new MediaStreamRecorder(stream);
        audioMediaRecorder.mimeType = 'audio/wav';
        audioMediaRecorder.ondataavailable = function (blob) {
            // POST/PUT "Blob" using FormData/XHR2
            var blobUrl = URL.createObjectURL(blob);
            playAudio('#audioView', blobUrl, true);
        };

        $('#audioView').hide();
    }

    function onAudioError(e) {
        console.error('Audio error: ', e);
    }

    function startListeningAudio() {
        $('#startMicrophoneBtn').prop('disabled', true);
        $('#beginAudioCaptureBtn').prop('disabled', false);
        navigator.getUserMedia(audioMediaConstraints, onAudioSuccess, onAudioError);
    }

    function toggleAudioCapture() {
        var btn = $('#beginAudioCaptureBtn');
        if (isAudioRecording) {
            btn.text('Begin Capture');
            audioMediaRecorder.stop();
        } else {
            btn.text('End Capture');
            audioMediaRecorder.start();
        }
        isAudioRecording = !isAudioRecording;
    }

    function toggleAudioPlayback() {
        var btn = $('#audioPlaybackBtn');
        audioPlayer.playPause();
        if (isAudioPlaying) {
            btn.text('Play Audio');
        } else {
            btn.text('Pause Audio');
        }
        isAudioPlaying = !isAudioPlaying;
    }

</script>

</body>
</html>